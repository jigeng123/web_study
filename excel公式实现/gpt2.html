<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>sheet-js.html — 简易 Excel 风格表格（支持通过 id 脚本操作）</title>
    <style>
      body {
        font-family: Inter, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB",
          sans-serif;
        margin: 18px;
        background: #f7f8fb;
      }
      .sheet {
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 6px 18px rgba(12, 18, 36, 0.08);
      }
      .sheet th,
      .sheet td {
        border: 1px solid #e6e9ef;
        padding: 6px 8px;
        min-width: 80px;
        height: 28px;
      }
      .sheet th {
        background: #fafbff;
        font-weight: 600;
        text-align: center;
      }
      .cell {
        outline: none;
        min-width: 60px;
      }
      .controls {
        margin-bottom: 12px;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .controls input[type="text"] {
        padding: 6px 8px;
        border: 1px solid #d7dbe6;
        border-radius: 6px;
        width: 320px;
      }
      .controls button {
        padding: 6px 10px;
        border-radius: 8px;
        border: 0;
        background: #3b82f6;
        color: #fff;
        cursor: pointer;
      }
      .log {
        margin-top: 12px;
        background: #0b1324;
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        font-size: 13px;
        max-height: 160px;
        overflow: auto;
      }
      .small {
        font-size: 12px;
        color: #6b7280;
      }
      .formula {
        color: #0f172a;
        font-weight: 600;
      }
      textarea#script {
        width: 100%;
        height: 120px;
        border-radius: 8px;
        padding: 8px;
        border: 1px solid #e6e9ef;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      }
    </style>
  </head>
  <body>
    <h2>sheet-js.html — 简易 Excel 风格表格</h2>
    <p class="small">
      说明：表格支持以 <code>=</code> 开头的公式（例如
      <code>=A1*2</code>、<code>=SUM(A1:A3)</code>）。你也可以在下方脚本框中写
      JS，使用 <code>getCellById</code> / <code>setCellById</code> 按 id
      操作单元格（id 格式为
      <code>cell-A1</code>）。修改任意单元格后会自动重新计算整个表格。
    </p>

    <div class="controls">
      <label class="small">行数：</label>
      <input id="rows" type="number" value="20" min="1" style="width: 70px" />
      <label class="small">列数：</label>
      <input id="cols" type="number" value="8" min="1" style="width: 70px" />
      <button id="build">重建表格</button>
      <button id="export">导出 CSV</button>
      <button id="clear">清空所有</button>
    </div>

    <div id="tableWrap"></div>

    <h3>脚本（可以通过 id 操作单元格）</h3>
    <textarea
      id="script"
      placeholder="// 示例：\n// setCellById('cell-A1', '=SUM(B1:B3)')\n// console.log(getCellValueById('cell-A1'))\n"
    ></textarea>
    <div style="margin-top: 8px; display: flex; gap: 8px">
      <button id="runScript">运行脚本</button>
      <button id="formatCells">将所有值格式化为文本（去除公式）</button>
    </div>

    <div class="log" id="log">就绪。</div>

    <script>
      /*
    功能要点：
      - 支持 A1 引用和区域引用 A1:B3
      - 支持函数 SUM, AVG, MIN, MAX
      - 单元格以 contenteditable 元素呈现，id = cell-<A1>
      - 任何单元格以 '=' 开头视为公式，自动求值并显示计算结果（而保留原始公式在 dataset.formula）
      - 提供 getCellById, setCellById, getCellValueById 等对外 JS API（通过 id 操作）
  */

      (function () {
        const tableWrap = document.getElementById("tableWrap");
        const logEl = document.getElementById("log");
        const rowsInput = document.getElementById("rows");
        const colsInput = document.getElementById("cols");
        const buildBtn = document.getElementById("build");
        const runScriptBtn = document.getElementById("runScript");
        const scriptArea = document.getElementById("script");
        const exportBtn = document.getElementById("export");
        const clearBtn = document.getElementById("clear");
        const formatBtn = document.getElementById("formatCells");

        let R = parseInt(rowsInput.value, 10);
        let C = parseInt(colsInput.value, 10);

        function colLabel(n) {
          // 1->A, 27->AA
          let s = "";
          while (n > 0) {
            let rem = (n - 1) % 26;
            s = String.fromCharCode(65 + rem) + s;
            n = Math.floor((n - 1) / 26);
          }
          return s;
        }

        function buildTable(rows, cols) {
          R = rows;
          C = cols;
          const tbl = document.createElement("table");
          tbl.className = "sheet";

          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");
          headerRow.appendChild(document.createElement("th"));
          for (let c = 1; c <= C; c++) {
            const th = document.createElement("th");
            th.textContent = colLabel(c);
            headerRow.appendChild(th);
          }
          thead.appendChild(headerRow);
          tbl.appendChild(thead);

          const tbody = document.createElement("tbody");
          for (let r = 1; r <= R; r++) {
            const tr = document.createElement("tr");
            const th = document.createElement("th");
            th.textContent = r;
            tr.appendChild(th);
            for (let c = 1; c <= C; c++) {
              const td = document.createElement("td");
              const id = `cell-${colLabel(c)}${r}`;
              const div = document.createElement("div");
              div.className = "cell";
              div.contentEditable = "true";
              div.spellcheck = "false";
              div.id = id;
              div.dataset.row = r;
              div.dataset.col = c;
              div.dataset.formula = "";
              div.dataset.value = "";
              div.addEventListener("blur", onCellBlur);
              div.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                  e.preventDefault();
                  div.blur();
                }
              });
              td.appendChild(div);
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
          tbl.appendChild(tbody);
          tableWrap.innerHTML = "";
          tableWrap.appendChild(tbl);
          recalcAll();
        }

        function log(msg) {
          const t = document.createElement("div");
          t.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
          logEl.appendChild(t);
          logEl.scrollTop = logEl.scrollHeight;
        }

        function onCellBlur(e) {
          const el = e.target;
          const text = el.innerText.trim();
          if (text.startsWith("=")) {
            el.dataset.formula = text.slice(1);
          } else {
            el.dataset.formula = "";
            el.dataset.value = text;
          }
          recalcAll();
        }

        // 返回单元格 DOM 或 null
        function getCellElByRef(ref) {
          // ref 可能是 A1 或 cell-A1 或直接ID
          if (!ref) return null;
          ref = String(ref).toUpperCase();
          if (ref.startsWith("CELL-")) return document.getElementById(ref);
          if (/^[A-Z]+\d+$/.test(ref))
            return document.getElementById("cell-" + ref);
          return document.getElementById(ref);
        }

        // 解析区域 A1:B2 -> 返回 ['A1','A2','B1','B2']
        function expandRange(range) {
          range = range.toUpperCase();
          if (!range.includes(":")) return [range];
          const [a, b] = range.split(":");
          const colToNum = (col) => {
            let n = 0;
            for (let i = 0; i < col.length; i++) {
              n = n * 26 + (col.charCodeAt(i) - 64);
            }
            return n;
          };
          const colA = a.match(/^[A-Z]+/)[0];
          const rowA = parseInt(a.match(/\d+$/)[0], 10);
          const colB = b.match(/^[A-Z]+/)[0];
          const rowB = parseInt(b.match(/\d+$/)[0], 10);
          const c1 = colToNum(colA),
            c2 = colToNum(colB);
          const r1 = Math.min(rowA, rowB),
            r2 = Math.max(rowA, rowB);
          const res = [];
          for (let c = c1; c <= c2; c++) {
            const colLabel = (() => {
              let s = "";
              let n = c;
              while (n > 0) {
                let rem = (n - 1) % 26;
                s = String.fromCharCode(65 + rem) + s;
                n = Math.floor((n - 1) / 26);
              }
              return s;
            })();
            for (let r = r1; r <= r2; r++) res.push(colLabel + r);
          }
          return res;
        }

        function getRawCellValue(ref) {
          const el = getCellElByRef(ref);
          if (!el) return "";
          if (el.dataset.formula) return null; // formula — 需要计算
          return el.dataset.value || el.innerText || "";
        }

        function getCellComputedValue(ref, visited = new Set()) {
          // ref like A1
          ref = String(ref).toUpperCase();
          if (visited.has(ref)) return "#CIRC";
          visited.add(ref);
          const el = getCellElByRef(ref);
          if (!el) return "";
          if (el.dataset.formula) {
            try {
              const formula = el.dataset.formula;
              const val = evalFormula(formula, visited);
              return val;
            } catch (e) {
              return "#ERR";
            }
          } else {
            const v = el.dataset.value || el.innerText || "";
            return v;
          }
        }

        function evalFormula(formula, visited) {
          // 支持 SUM, AVG, MIN, MAX, 基本算数 + 单元格引用和区域
          let expr = formula.toUpperCase();

          // 先处理函数
          expr = expr.replace(/SUM\s*\(([^)]+)\)/g, function (_, inner) {
            const parts = inner.split(",").map((s) => s.trim());
            const vals = [];
            parts.forEach((p) => {
              expandRange(p).forEach((ref) => {
                const v = parseFloat(
                  getCellComputedValue(ref, new Set(visited)) || 0
                );
                if (!isNaN(v)) vals.push(v);
              });
            });
            const s = vals.reduce((a, b) => a + b, 0);
            return "(" + s + ")";
          });

          expr = expr.replace(/AVG\s*\(([^)]+)\)/g, function (_, inner) {
            const parts = inner.split(",").map((s) => s.trim());
            const vals = [];
            parts.forEach((p) => {
              expandRange(p).forEach((ref) => {
                const v = parseFloat(
                  getCellComputedValue(ref, new Set(visited)) || 0
                );
                if (!isNaN(v)) vals.push(v);
              });
            });
            const s = vals.length
              ? vals.reduce((a, b) => a + b, 0) / vals.length
              : 0;
            return "(" + s + ")";
          });

          expr = expr.replace(/MIN\s*\(([^)]+)\)/g, function (_, inner) {
            const parts = inner.split(",").map((s) => s.trim());
            const vals = [];
            parts.forEach((p) => {
              expandRange(p).forEach((ref) => {
                const v = parseFloat(
                  getCellComputedValue(ref, new Set(visited)) || 0
                );
                if (!isNaN(v)) vals.push(v);
              });
            });
            const s = vals.length ? Math.min(...vals) : 0;
            return "(" + s + ")";
          });

          expr = expr.replace(/MAX\s*\(([^)]+)\)/g, function (_, inner) {
            const parts = inner.split(",").map((s) => s.trim());
            const vals = [];
            parts.forEach((p) => {
              expandRange(p).forEach((ref) => {
                const v = parseFloat(
                  getCellComputedValue(ref, new Set(visited)) || 0
                );
                if (!isNaN(v)) vals.push(v);
              });
            });
            const s = vals.length ? Math.max(...vals) : 0;
            return "(" + s + ")";
          });

          // 替换单元格引用 A1 -> (value)
          expr = expr.replace(/([A-Z]+\d+)/g, function (_, ref) {
            const v = getCellComputedValue(ref, new Set(visited));
            const num = parseFloat(v);
            if (!isNaN(num)) return "(" + num + ")";
            // 非数值，作为字符串包裹
            return '"' + String(v).replace(/"/g, '\\"') + '"';
          });

          // 现在用安全的 eval — 限制字符，只允许数字运算和 +-*/().以及引号
          if (/[^0-9\.\+\-\*\/\(\)\"\,\s]/.test(expr)) {
            // 非法字符（例如变量名）则直接返回错误
            return "#ERR";
          }
          try {
            // eslint-disable-next-line no-eval
            const v = eval(expr);
            if (v === undefined) return "";
            return v;
          } catch (e) {
            return "#ERR";
          }
        }

        function recalcAll() {
          // 逐个遍历单元格，如果 dataset.formula 存在则计算
          const els = document.querySelectorAll('[id^="cell-"]');
          els.forEach((el) => {
            if (el.dataset.formula) {
              const val = getCellComputedValue(
                el.id.replace(/^cell-/, "").toUpperCase()
              );
              el.dataset.value = val === null ? "" : String(val);
              el.innerText = el.dataset.value;
            }
          });
        }

        // 对外 API: 通过 id 操作
        window.getCellById = function (id) {
          return getCellElByRef(id);
        };
        window.setCellById = function (id, text) {
          const el = getCellElByRef(id);
          if (!el) throw new Error("找不到单元格: " + id);
          if (String(text).startsWith("=")) {
            el.dataset.formula = String(text).slice(1);
          } else {
            el.dataset.formula = "";
            el.dataset.value = String(text);
          }
          el.innerText = el.dataset.formula
            ? "=" + el.dataset.formula
            : el.dataset.value;
          recalcAll();
        };
        window.getCellValueById = function (id) {
          const ref = String(id)
            .replace(/^cell-/i, "")
            .toUpperCase();
          return getCellComputedValue(ref);
        };

        // 插件的一些工具
        buildBtn.addEventListener("click", () => {
          const r = Math.max(1, parseInt(rowsInput.value, 10) || 1);
          const c = Math.max(1, parseInt(colsInput.value, 10) || 1);
          buildTable(r, c);
          log(`已重建表格 ${r} 行 x ${c} 列`);
        });

        runScriptBtn.addEventListener("click", () => {
          const code = scriptArea.value;
          try {
            // 在 try 中运行用户脚本，暴露的 API: getCellById, setCellById, getCellValueById
            // eslint-disable-next-line no-eval
            const fn = new Function(code);
            fn();
            log("脚本执行完成。");
          } catch (e) {
            log("脚本执行错误: " + e.message);
          }
        });

        exportBtn.addEventListener("click", () => {
          const rows = [];
          for (let r = 1; r <= R; r++) {
            const row = [];
            for (let c = 1; c <= C; c++) {
              const ref = colLabel(c) + r;
              const el = getCellElByRef(ref);
              row.push(
                '"' +
                  (el
                    ? el.dataset.formula
                      ? "=" + el.dataset.formula
                      : el.dataset.value || el.innerText
                    : "") +
                  '"'
              );
            }
            rows.push(row.join(","));
          }
          const csv = rows.join("\n");
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "sheet-export.csv";
          a.click();
          URL.revokeObjectURL(url);
        });

        clearBtn.addEventListener("click", () => {
          const els = document.querySelectorAll('[id^="cell-"]');
          els.forEach((el) => {
            el.dataset.formula = "";
            el.dataset.value = "";
            el.innerText = "";
          });
          log("已清空所有单元格。");
        });

        formatBtn.addEventListener("click", () => {
          const els = document.querySelectorAll('[id^="cell-"]');
          els.forEach((el) => {
            if (el.dataset.formula) {
              el.dataset.value = el.innerText;
              el.dataset.formula = "";
            }
          });
          log("已将所有公式转换为文本值（去除公式）。");
        });

        // 初始建表
        buildTable(R, C);
        // 示例：预置一些数据
        setTimeout(() => {
          try {
            setCellById("cell-A1", "10");
            setCellById("cell-A2", "20");
            setCellById("cell-A3", "30");
            setCellById("cell-B1", "=A1+A2");
            setCellById("cell-B2", "=SUM(A1:A3)");
            log("示例已填充：A1=10, A2=20, A3=30, B1= =A1+A2, B2= =SUM(A1:A3)");
          } catch (e) {}
        }, 300);
      })();
    </script>
  </body>
</html>
