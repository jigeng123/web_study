<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sheet-JS - 网页版Excel公式</title>
    <style>
      /* 页面基本样式 */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        padding: 20px;
        background-color: #f4f5f7;
        color: #172b4d;
      }
      h1 {
        text-align: center;
        color: #091e42;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      p {
        line-height: 1.6;
      }

      /* 表格样式，使其看起来像Excel */
      table {
        border-collapse: collapse;
        margin-top: 20px;
        width: 100%;
      }

      th,
      td {
        border: 1px solid #c4cdd5;
        padding: 0;
        position: relative;
        min-width: 80px;
      }

      /* 表头样式 */
      th {
        background-color: #f4f5f7;
        font-weight: bold;
        text-align: center;
        padding: 8px;
        color: #42526e;
      }

      /* 行号样式 */
      .row-header {
        background-color: #f4f5f7;
        font-weight: bold;
        text-align: center;
        padding: 8px;
      }

      /* 单元格输入框样式 */
      td input {
        width: 100%;
        height: 100%;
        border: none;
        outline: 2px solid transparent; /* 用于聚焦时显示 */
        box-sizing: border-box;
        padding: 8px;
        font-size: 14px;
        text-align: left;
      }

      /* 输入框聚焦时高亮显示 */
      td input:focus {
        outline-color: #0052cc;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Sheet-JS 示例</h1>
      <p>
        这是一个使用 JavaScript
        实现的简易电子表格。您可以在单元格中输入数字，也可以输入以等号
        (<code>=</code>) 开头的公式。
      </p>
      <p><b>使用方法：</b></p>
      <ol>
        <li>
          在任意单元格 (例如 <strong>A1</strong>) 中输入一个数字，比如
          <code>10</code>。
        </li>
        <li>
          在另一个单元格 (例如 <strong>A2</strong>) 中输入另一个数字，比如
          <code>20</code>。
        </li>
        <li>
          在第三个单元格 (例如 <strong>B1</strong>)
          中输入一个公式，引用前面的单元格。例如：<code>=A1+A2</code>。
        </li>
        <li>
          按下回车或点击其他地方，<strong>B1</strong> 单元格会自动计算并显示结果
          <code>30</code>。
        </li>
        <li>
          现在尝试修改 <strong>A1</strong> 或 <strong>A2</strong> 的值，您会看到
          <strong>B1</strong> 的结果会实时更新！
        </li>
      </ol>

      <table id="sheet">
        <thead>
          <tr>
            <th></th>
            <th>A</th>
            <th>B</th>
            <th>C</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="row-header">1</td>
            <td><input type="text" id="A1" /></td>
            <td><input type="text" id="B1" /></td>
            <td><input type="text" id="C1" /></td>
          </tr>
          <tr>
            <td class="row-header">2</td>
            <td><input type="text" id="A2" /></td>
            <td><input type="text" id="B2" /></td>
            <td><input type="text" id="C2" /></td>
          </tr>
          <tr>
            <td class="row-header">3</td>
            <td><input type="text" id="A3" /></td>
            <td><input type="text" id="B3" /></td>
            <td><input type="text" id="C3" /></td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      // 等待DOM内容完全加载后再执行脚本
      document.addEventListener("DOMContentLoaded", () => {
        const sheet = document.getElementById("sheet");

        // 获取表格中所有的输入框
        const cells = sheet.querySelectorAll('input[type="text"]');

        /**
         * 核心函数：重新计算所有单元格的值
         * 每次有单元格变动时都会调用此函数，以确保数据同步
         */
        const recalculateAll = () => {
          // 遍历所有单元格
          cells.forEach((cell) => {
            // 检查单元格是否包含公式（我们将其存储在 data-formula 属性中）
            const formula = cell.dataset.formula;
            if (formula) {
              try {
                // 如果有公式，则进行计算
                const result = evaluateFormula(formula);
                cell.value = result;
              } catch (error) {
                // 如果计算出错，显示错误信息
                console.error(
                  `Error evaluating formula for ${cell.id}:`,
                  error
                );
                cell.value = "#ERROR!";
              }
            }
          });
        };

        /**
         * 计算公式字符串的值
         * @param {string} formula - 以 '=' 开头的公式字符串，例如 '=A1+B2'
         * @returns {number|string} - 返回计算结果或错误信息
         */
        const evaluateFormula = (formula) => {
          // 去掉开头的 '='
          let expression = formula.substring(1);

          // 使用正则表达式查找所有类似 A1, B12, C3 的单元格引用
          expression = expression.replace(/[A-Z]+\d+/g, (match) => {
            const referencedCell = document.getElementById(match);
            if (!referencedCell) {
              throw new Error(`Reference does not exist: ${match}`);
            }
            // 获取被引用单元格的值，并转换为数字。如果不是有效数字，则视为 0
            return parseFloat(referencedCell.value) || 0;
          });

          // 使用 Function 构造函数来安全地执行计算
          // 这比 eval() 更安全，因为它在全局作用域中运行
          try {
            // 创建一个函数并立即执行以获得结果
            return new Function(`return ${expression}`)();
          } catch (error) {
            throw new Error(`Invalid expression: ${expression}`);
          }
        };

        // 为每个单元格输入框添加 'input' 事件监听器
        cells.forEach((cell) => {
          cell.addEventListener("input", (event) => {
            const inputElement = event.target;
            const value = inputElement.value;

            // 检查输入内容是否以 '=' 开头，来判断是公式还是普通数值
            if (value.startsWith("=")) {
              // 如果是公式，将其存储在 'data-formula' 自定义属性中
              // 这样即使单元格显示的是计算结果，原始公式也不会丢失
              inputElement.dataset.formula = value;
            } else {
              // 如果不是公式，清除 'data-formula' 属性
              delete inputElement.dataset.formula;
            }

            // 每次输入后，都重新计算所有单元格
            recalculateAll();
          });

          // 添加 'focus' 事件监听器，当用户点击单元格时，如果里面是公式，则显示公式原文
          cell.addEventListener("focus", (event) => {
            const inputElement = event.target;
            if (inputElement.dataset.formula) {
              inputElement.value = inputElement.dataset.formula;
            }
          });

          // 添加 'blur' 事件监听器，当用户离开单元格时，重新显示计算结果
          cell.addEventListener("blur", (event) => {
            recalculateAll();
          });
        });

        // 初始加载时也计算一次，以处理预设的公式（虽然本例中没有）
        recalculateAll();
      });
    </script>
  </body>
</html>
