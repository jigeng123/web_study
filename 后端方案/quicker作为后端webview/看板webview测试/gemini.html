<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>功能丰富的 Kanban 看板</title>
    <style>
      :root {
        --board-bg: #f4f5f7;
        --list-bg: #ebecf0;
        --card-bg: #ffffff;
        --text-color: #172b4d;
        --border-radius: 6px;
        --spacing: 8px;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: var(--board-bg);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        overflow-x: auto;
      }
      .toolbar {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        align-items: center;
      }
      .toolbar select,
      .toolbar input,
      .toolbar button {
        padding: 8px 12px;
        border-radius: var(--border-radius);
        border: 1px solid #ccc;
      }
      #kanban-board {
        display: flex;
        gap: var(--spacing);
        align-items: flex-start;
      }
      .kanban-list {
        background-color: var(--list-bg);
        border-radius: var(--border-radius);
        width: 300px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 100px);
      }
      .list-header {
        padding: 10px 15px;
        font-weight: bold;
        border-bottom: 1px solid #ccc;
      }
      .list-cards {
        padding: var(--spacing);
        overflow-y: auto;
        min-height: 50px;
        flex-grow: 1;
      }
      .kanban-card {
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 15px;
        margin-bottom: var(--spacing);
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        cursor: grab;
        border-left: 5px solid transparent;
        transition: box-shadow 0.2s;
      }
      .kanban-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .kanban-card.dragging {
        opacity: 0.5;
        transform: rotate(3deg);
      }
      .kanban-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .kanban-card .card-checkbox {
        margin-right: 10px;
      }
      .kanban-card .card-title {
        font-weight: 600;
        flex-grow: 1;
      }
      .kanban-card .card-content {
        font-size: 0.9em;
        margin-bottom: 10px;
        white-space: pre-wrap;
      }
      .card-footer {
        font-size: 0.8em;
        color: #5e6c84;
        margin-top: 15px;
      }
      .card-footer .due-date {
        color: #198754;
        font-weight: bold;
      }
      .card-footer .due-date.overdue {
        color: #dc3545;
      }
      .card-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 10px;
      }
      .card-tag {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75em;
        font-weight: bold;
      }
      .add-card-btn {
        padding: 10px;
        width: 100%;
        border: none;
        background: transparent;
        cursor: pointer;
        text-align: left;
        color: #5e6c84;
        border-radius: var(--border-radius);
      }
      .add-card-btn:hover {
        background-color: rgba(9, 30, 66, 0.08);
      }
      .card-editor {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .card-editor input,
      .card-editor textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: var(--border-radius);
      }
      #add-list-container {
        flex-shrink: 0;
      }
      #add-list-container input {
        width: 200px;
        padding: 8px;
        border-radius: var(--border-radius);
        border: 1px solid #ccc;
      }
      #add-list-container button {
        padding: 8px 12px;
        border: none;
        background-color: #0d6efd;
        color: white;
        border-radius: var(--border-radius);
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <div>
        <label for="tag-filter">按标签筛选:</label>
        <select id="tag-filter">
          <option value="">所有</option>
        </select>
      </div>
      <div id="add-list-container">
        <input
          type="text"
          id="new-list-title"
          placeholder="输入新列表标题..."
        />
        <button id="add-list-btn">新建列表</button>
      </div>
    </div>

    <div id="kanban-board"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- 1. DATA ---
        let kanbanData = {
          lists: [
            {
              id: "list-1",
              title: "待办事项 (To Do)",
              isDoneList: false,
              cards: [
                {
                  id: "card-1",
                  title: "设计数据库架构",
                  content: "为新项目设计用户表和产品表。",
                  completed: false,
                  createdAt: "2025-09-24T14:30:00Z",
                  dueDate: "2025-09-28T23:59:59Z",
                  colors: { background: "#ffffff", font: "#172b4d" },
                  tags: [
                    {
                      text: "紧急",
                      colors: { background: "#dc3545", font: "#ffffff" },
                    },
                    {
                      text: "后端",
                      colors: { background: "#0d6efd", font: "#ffffff" },
                    },
                  ],
                },
                {
                  id: "card-2",
                  title: "开发登录页面",
                  content: "使用 Vue.js 和 Element Plus。",
                  completed: false,
                  createdAt: "2025-09-25T10:00:00Z",
                  dueDate: "2025-09-26T23:59:59Z",
                  colors: { background: "#fff3cd", font: "#664d03" },
                  tags: [
                    {
                      text: "前端",
                      colors: { background: "#198754", font: "#ffffff" },
                    },
                  ],
                },
              ],
            },
            {
              id: "list-2",
              title: "进行中 (In Progress)",
              isDoneList: false,
              cards: [
                {
                  id: "card-3",
                  title: "API 接口对接",
                  content: "对接用户认证和产品列表接口。",
                  completed: false,
                  createdAt: "2025-09-23T11:00:00Z",
                  dueDate: null,
                  colors: { background: "#cfe2ff", font: "#0a58ca" },
                  tags: [
                    {
                      text: "前端",
                      colors: { background: "#198754", font: "#ffffff" },
                    },
                    {
                      text: "后端",
                      colors: { background: "#0d6efd", font: "#ffffff" },
                    },
                  ],
                },
              ],
            },
            {
              id: "list-3",
              title: "完成 (Done)",
              isDoneList: true,
              cards: [
                {
                  id: "card-4",
                  title: "项目初始化",
                  content: "创建 Git 仓库和项目脚手架。",
                  completed: true,
                  createdAt: "2025-09-22T09:00:00Z",
                  dueDate: null,
                  colors: { background: "#ffffff", font: "#172b4d" },
                  tags: [
                    {
                      text: "DevOps",
                      colors: { background: "#6c757d", font: "#ffffff" },
                    },
                  ],
                },
              ],
            },
          ],
          allTags: [
            // 全局标签库
            {
              text: "紧急",
              colors: { background: "#dc3545", font: "#ffffff" },
            },
            {
              text: "后端",
              colors: { background: "#0d6efd", font: "#ffffff" },
            },
            {
              text: "前端",
              colors: { background: "#198754", font: "#ffffff" },
            },
            {
              text: "UI/UX",
              colors: { background: "#6f42c1", font: "#ffffff" },
            },
            {
              text: "DevOps",
              colors: { background: "#6c757d", font: "#ffffff" },
            },
          ],
        };

        const board = document.getElementById("kanban-board");
        const tagFilter = document.getElementById("tag-filter");

        let draggedCard = null;
        let sourceListId = null;

        // --- 2. CORE FUNCTIONS ---

        function renderBoard() {
          board.innerHTML = "";
          const selectedTag = tagFilter.value;

          kanbanData.lists.forEach((list) => {
            const listEl = document.createElement("div");
            listEl.className = "kanban-list";
            listEl.dataset.listId = list.id;

            listEl.innerHTML = `
                    <div class="list-header">${list.title}</div>
                    <div class="list-cards"></div>
                    <button class="add-card-btn">+ 添加卡片</button>
                `;

            const cardsContainer = listEl.querySelector(".list-cards");

            // 筛选逻辑
            const filteredCards = selectedTag
              ? list.cards.filter((card) =>
                  card.tags.some((tag) => tag.text === selectedTag)
                )
              : list.cards;

            filteredCards.forEach((card) => {
              cardsContainer.appendChild(createCardEl(card, list.id));
            });

            board.appendChild(listEl);
          });
          updateTagFilterOptions();
          setupDragAndDrop();
        }

        function createCardEl(card, listId) {
          const cardEl = document.createElement("div");
          cardEl.className = "kanban-card";
          cardEl.draggable = true;
          cardEl.dataset.cardId = card.id;
          cardEl.dataset.listId = listId;
          cardEl.style.backgroundColor = card.colors.background;
          cardEl.style.color = card.colors.font;
          if (card.completed) {
            cardEl.style.borderLeftColor = "#198754";
          }

          const now = new Date();
          const dueDate = card.dueDate ? new Date(card.dueDate) : null;
          let dueDateStr = "无";
          let overdueClass = "";
          if (dueDate) {
            dueDateStr = dueDate.toLocaleString("zh-CN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            });
            if (!card.completed && now > dueDate) {
              overdueClass = "overdue";
            }
          }

          cardEl.innerHTML = `
                <div class="card-header">
                    <input type="checkbox" class="card-checkbox" ${
                      card.completed ? "checked" : ""
                    }>
                    <span class="card-title">${card.title}</span>
                </div>
                <div class="card-content">${card.content}</div>
                <div class="card-tags">
                    ${card.tags
                      .map(
                        (tag) =>
                          `<span class="card-tag" style="background-color:${tag.colors.background}; color:${tag.colors.font};">${tag.text}</span>`
                      )
                      .join("")}
                </div>
                <div class="card-footer">
                    <div>创建于: ${new Date(card.createdAt).toLocaleDateString(
                      "zh-CN"
                    )}</div>
                    <div class="due-date ${overdueClass}">截止日期: ${dueDateStr}</div>
                </div>
            `;
          return cardEl;
        }

        function updateTagFilterOptions() {
          const existingOptions = new Set(
            Array.from(tagFilter.options).map((o) => o.value)
          );
          const allTagsInUse = new Set(
            kanbanData.lists
              .flatMap((l) => l.cards)
              .flatMap((c) => c.tags.map((t) => t.text))
          );

          allTagsInUse.forEach((tagText) => {
            if (!existingOptions.has(tagText)) {
              const option = document.createElement("option");
              option.value = tagText;
              option.textContent = tagText;
              tagFilter.appendChild(option);
            }
          });
        }

        function getCardAndList(cardId) {
          for (const list of kanbanData.lists) {
            const card = list.cards.find((c) => c.id === cardId);
            if (card) {
              return { card, list };
            }
          }
          return { card: null, list: null };
        }

        function findListById(listId) {
          return kanbanData.lists.find((l) => l.id === listId);
        }

        // --- 3. EVENT HANDLERS & LOGIC ---

        // Drag and Drop
        function setupDragAndDrop() {
          const cards = document.querySelectorAll(".kanban-card");
          const lists = document.querySelectorAll(".kanban-list");

          cards.forEach((card) => {
            card.addEventListener("dragstart", (e) => {
              draggedCard = card;
              sourceListId = card.dataset.listId;
              setTimeout(() => card.classList.add("dragging"), 0);
            });

            card.addEventListener("dragend", () => {
              draggedCard.classList.remove("dragging");
              draggedCard = null;
              sourceListId = null;
            });
          });

          lists.forEach((list) => {
            list.addEventListener("dragover", (e) => {
              e.preventDefault(); // Necessary to allow dropping
            });

            list.addEventListener("drop", (e) => {
              e.preventDefault();
              if (!draggedCard) return;

              const targetListEl = e.target.closest(".kanban-list");
              if (!targetListEl) return;

              const targetListId = targetListEl.dataset.listId;
              const cardId = draggedCard.dataset.cardId;

              if (sourceListId === targetListId) return;

              // Update data model
              const { card, list: oldList } = getCardAndList(cardId);
              if (!card || !oldList) return;

              const targetList = findListById(targetListId);
              if (!targetList) return;

              // Move card in data
              oldList.cards = oldList.cards.filter((c) => c.id !== cardId);
              targetList.cards.push(card);

              // Auto-check if moved to a "Done" list
              if (targetList.isDoneList) {
                card.completed = true;
              }

              renderBoard(); // Re-render the whole board
            });
          });
        }

        // Add new card
        board.addEventListener("click", (e) => {
          if (e.target.classList.contains("add-card-btn")) {
            const listEl = e.target.closest(".kanban-list");
            const listId = listEl.dataset.listId;
            const cardsContainer = listEl.querySelector(".list-cards");

            e.target.style.display = "none"; // Hide button

            const editorEl = document.createElement("div");
            editorEl.className = "kanban-card card-editor";
            editorEl.innerHTML = `
                    <input type="text" placeholder="卡片标题..." class="new-card-title">
                    <textarea placeholder="卡片内容..." class="new-card-content"></textarea>
                    <input type="date" class="new-card-due-date">
                    <button class="save-card-btn">保存</button>
                    <button class="cancel-card-btn">取消</button>
                `;
            cardsContainer.appendChild(editorEl);

            const titleInput = editorEl.querySelector(".new-card-title");
            const contentInput = editorEl.querySelector(".new-card-content");
            titleInput.focus(); // Auto-focus on title

            const removeEditor = () => {
              editorEl.remove();
              e.target.style.display = "block";
            };

            const saveCard = () => {
              const title = titleInput.value.trim();
              if (!title) {
                alert("标题不能为空！");
                return;
              }
              const newCard = {
                id: "card-" + Date.now(),
                title: title,
                content: contentInput.value.trim(),
                completed: false,
                createdAt: new Date().toISOString(),
                dueDate: editorEl.querySelector(".new-card-due-date").value,
                colors: { background: "#ffffff", font: "#172b4d" },
                tags: [],
              };
              const list = findListById(listId);
              list.cards.push(newCard);
              renderBoard();
            };

            editorEl.querySelector(".save-card-btn").onclick = saveCard;
            editorEl.querySelector(".cancel-card-btn").onclick = removeEditor;

            titleInput.addEventListener("keydown", (ev) => {
              if (ev.key === "Enter") {
                ev.preventDefault();
                contentInput.focus();
              }
            });

            contentInput.addEventListener("keydown", (ev) => {
              if (ev.key === "Enter") {
                ev.preventDefault();
                saveCard();
                // Trigger a new card creation
                e.target.click();
              }
            });
          }
        });

        // Checkbox click
        board.addEventListener("change", (e) => {
          if (e.target.classList.contains("card-checkbox")) {
            const cardEl = e.target.closest(".kanban-card");
            const cardId = cardEl.dataset.cardId;
            const { card, list } = getCardAndList(cardId);

            if (!card) return;

            card.completed = e.target.checked;

            const doneList = kanbanData.lists.find((l) => l.isDoneList);
            if (card.completed && doneList && list.id !== doneList.id) {
              // Move to done list
              list.cards = list.cards.filter((c) => c.id !== cardId);
              doneList.cards.push(card);
            }
            renderBoard();
          }
        });

        // Add new list
        document
          .getElementById("add-list-btn")
          .addEventListener("click", () => {
            const titleInput = document.getElementById("new-list-title");
            const title = titleInput.value.trim();
            if (title) {
              const newList = {
                id: "list-" + Date.now(),
                title: title,
                isDoneList: false,
                cards: [],
              };
              kanbanData.lists.push(newList);
              titleInput.value = "";
              renderBoard();
            }
          });

        // Tag filter
        tagFilter.addEventListener("change", renderBoard);

        // Due date reminder check (simulated)
        function checkDueDates() {
          const now = new Date();
          console.log(`[${now.toLocaleTimeString()}] 正在检查截止日期...`);
          kanbanData.lists.forEach((list) => {
            list.cards.forEach((card) => {
              const dueDate = card.dueDate ? new Date(card.dueDate) : null;
              if (dueDate && !card.completed && now > dueDate) {
                // In a real app, you would send this to a backend.
                // Here, we just simulate it with an alert.
                const timeDiff = now.getTime() - dueDate.getTime();
                const hoursOverdue = Math.floor(timeDiff / (1000 * 60 * 60));

                // To prevent spamming alerts, we could add a "notified" flag to the card object.
                if (!card.notifiedOverdue) {
                  alert(
                    `提醒: 卡片 "${card.title}" 已逾期 ${hoursOverdue} 小时!`
                  );
                  console.warn(`模拟向后端发送提醒: 卡片 ${card.id} 已逾期。`);
                  card.notifiedOverdue = true; // Mark as notified
                }
              }
            });
          });
          renderBoard(); // Re-render to show overdue styles if any
        }

        // --- 4. INITIALIZATION ---
        renderBoard();
        setInterval(checkDueDates, 60000); // Check every 60 seconds
      });
    </script>
  </body>
</html>
